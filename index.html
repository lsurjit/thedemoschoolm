
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Records Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Generic Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .receipt {
            border: 2px solid black;
            padding: 2rem;
            width: 100%;
            box-sizing: border-box;
            background-color: white;
            color: black;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        /* New receipt field styling for print */
        .receipt-field {
            display: block; /* Ensure each field is on a new line */
            padding: 0.25rem 0;
        }
        .receipt-field span:first-child {
            font-weight: 600;
        }
        
        @media print {
            @page {
                size: A4 portrait;
                margin: 0 !important;
            }
            body {
            margin: 0 !important; 
            padding: 0 !important; 
            background-color: white;
            }
            body * {
            visibility: hidden !important;
            max-height: none !important;
            margin: 0 !important; 
            padding: 0 !important;
            }

            .modal, .modal * {
                visibility: visible !important;
                background-color: white;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }
            #receiptModal .modal-content {
                box-shadow: none !important;
                border: none !important;
                background-color: white !important;
                padding: 0 !important;
                width: 98% !important;
                max-width: none !important;
                height: auto !important;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                overflow: hidden;
            }
            .receipt {
                width: 97%;
                border: 2px solid black;
                box-shadow: none;
                padding: 1cm;
                box-sizing: border-box;
            }
            .close-btn, #print-receipt-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-sm lg:max-w-4xl border border-slate-200 transform transition-transform duration-300 hover:scale-[1.01]">
        <h1 class="text-4xl font-extrabold text-center text-slate-800 mb-8 tracking-wide">The Demo School</h1>
        <h1 class="text-3xl font-extrabold text-center text-slate-800 mb-8 tracking-wide">2025-26</h1>
        <h1 class="text-3xl font-extrabold text-center text-slate-800 mb-8 tracking-wide">Student Data Managements</h1>
        <!-- Main Menu Section -->
        <div id="main-menu" class="flex flex-col justify-center space-y-4">
            <button type="button" id="update-student-btn"
                    class="w-full flex justify-center py-4 px-6 border border-transparent rounded-xl shadow-lg text-lg font-semibold text-white bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-green-500 transition duration-300 ease-in-out transform hover:scale-105 hover:shadow-xl">
                Update Student
            </button>
            <button type="button" id="view-records-btn"
                    class="w-full flex justify-center py-4 px-6 border border-transparent rounded-xl shadow-lg text-lg font-semibold text-white bg-gradient-to-r from-violet-500 to-purple-600 hover:from-violet-600 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-purple-500 transition duration-300 ease-in-out transform hover:scale-105 hover:shadow-xl">
                View Student Records
            </button>
            <button type="button" id="update-payment-btn"
                    class="w-full flex justify-center py-4 px-6 border border-transparent rounded-xl shadow-lg text-lg font-semibold text-white bg-gradient-to-r from-sky-500 to-indigo-600 hover:from-sky-600 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                Update Payment
            </button>
            <!-- Payment Status Button (Opens new tab) -->
            <button type="button" id="payment-status-btn"
                    class="w-full flex justify-center py-4 px-6 border border-transparent rounded-xl shadow-lg text-lg font-semibold text-white bg-gradient-to-r from-orange-500 to-yellow-600 hover:from-orange-600 hover:to-yellow-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-yellow-500 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                Payment Status
            </button>
        </div>

        <!-- Student Data Entry Form Section -->
        <div id="student-form-section" class="hidden">
            <form id="student-entry-form" class="space-y-6">
                <!-- Group: Class Name & Admission No (Updated Order) -->
                <div class="flex flex-col md:flex-row md:space-x-4 space-y-6 md:space-y-0">
                    <div class="flex-1">
                        <label for="class-name" class="block text-sm font-medium text-gray-700">Class Name</label>
                        <select id="class-name" name="Class Name" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                            <option value="">Select Class</option>
                            <option value="Class-1">Class-1</option>
                            <option value="Class-2">Class-2</option>
                            <option value="Class-3">Class-3</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="admission-no" class="block text-sm font-medium text-gray-700">Admission No</label>
                        <input type="text" id="admission-no" name="Admission No" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                    </div>
                </div>
                
                <!-- Single Field: Name -->
                <div>
                    <label for="student-name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="student-name" name="Name" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                </div>
                
                <!-- Group: Roll No, Section, & Gender -->
                <div class="flex flex-col md:flex-row md:space-x-4 space-y-6 md:space-y-0">
                    <div class="flex-1">
                        <label for="roll-no" class="block text-sm font-medium text-gray-700">Roll No</label>
                        <input type="text" id="roll-no" name="Roll No" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                    </div>
                    <div class="flex-1">
                        <label for="section" class="block text-sm font-medium text-gray-700">Section</label>
                        <input type="text" id="section" name="Section" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                    </div>
                    <div class="flex-1">
                        <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                        <select id="gender" name="Gender" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <!-- Group: Date of Birth & Contact No -->
                <div class="flex flex-col md:flex-row md:space-x-4 space-y-6 md:space-y-0">
                    <div class="flex-1">
                        <label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                        <input type="date" id="dob" name="Date of Birth" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                    </div>
                    <div class="flex-1">
                        <label for="contact-no" class="block text-sm font-medium text-gray-700">Contact No</label>
                        <input type="tel" id="contact-no" name="Contact No" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                    </div>
                </div>
                
                <!-- Single Field: Father Name -->
                <div>
                    <label for="father-name" class="block text-sm font-medium text-gray-700">Father Name</label>
                    <input type="text" id="father-name" name="Father Name" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                </div>
                
                <!-- Single Field: Address -->
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                    <textarea id="address" name="Address" rows="3" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required></textarea>
                </div>

                <div class="flex justify-between space-x-4 pt-4">
                    <button type="button" id="back-btn-form"
                            class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-500 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                        Back
                    </button>
                    <button type="button" id="bulk-update-btn-form"
                            class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                        Bulk Update
                    </button>
                    <button type="submit"
                            class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                        Submit
                    </button>
                </div>
            </form>
        </div>

        <!-- Bulk Update Section -->
        <div id="bulk-update-section" class="hidden">
            <h2 class="text-3xl font-bold text-center text-slate-700 mb-6">Bulk Update Student Records</h2>
            <div class="space-y-6">
                <div>
                    <label for="bulk-class-name" class="block text-sm font-medium text-gray-700">Class Name</label>
                    <select id="bulk-class-name" name="Class Name" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                        <option value="">Select Class</option>
                        <option value="Class-1">Class-1</option>
                        <option value="Class-2">Class-2</option>
                        <option value="Class-3">Class-3</option>
                    </select>
                </div>
                <div>
                    <label for="bulk-upload-file" class="block text-sm font-medium text-gray-700">Upload File</label>
                    <input type="file" id="bulk-upload-file" name="bulkUploadFile" class="mt-1 block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-violet-50 file:text-violet-700
                        hover:file:bg-violet-100" />
                </div>
                <div class="flex justify-between space-x-4 pt-4">
                    <button type="button" id="download-template-btn"
                            class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                        Download Template
                    </button>
                    <button type="button" id="view-and-conform-btn"
                            class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                        View & Confirm
                    </button>
                </div>
                <div class="flex justify-between space-x-4 pt-4">
                    <button type="button" id="back-btn-bulk"
                            class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-500 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                        Back
                    </button>
                </div>
            </div>
        </div>

        <!-- Bulk Preview Section -->
        <div id="bulk-preview-section" class="hidden">
            <h2 class="text-3xl font-bold text-center text-slate-700 mb-6">Confirm Upload Data</h2>
            <div class="flex justify-around items-center bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="text-center">
                    <p class="text-sm font-semibold text-gray-500">Total Students</p>
                    <p id="total-students-count" class="text-3xl font-bold text-slate-800 mt-1">0</p>
                </div>
                <div class="text-center">
                    <p class="text-sm font-semibold text-gray-500">Total Male</p>
                    <p id="total-male-count" class="text-3xl font-bold text-blue-500 mt-1">0</p>
                </div>
                <div class="text-center">
                    <p class="text-sm font-semibold text-gray-500">Total Female</p>
                    <p id="total-female-count" class="text-3xl font-bold text-pink-500 mt-1">0</p>
                </div>
            </div>
            <div id="preview-table-container" class="bg-gray-100 p-4 rounded-lg border-2 border-gray-300 max-h-96 overflow-y-auto">
                <!-- Preview table will be inserted here by JavaScript -->
            </div>
            <div class="flex justify-between space-x-4 pt-4 mt-6">
                <button type="button" id="back-btn-preview"
                        class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-500 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                    Back
                </button>
                <button type="button" id="confirm-upload-btn"
                        class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                    Confirm Upload
                </button>
            </div>
        </div>

        <!-- View Records Section -->
        <div id="view-records-section" class="hidden">
            <div class="flex flex-col items-center">
                <h2 id="records-title" class="text-3xl font-bold text-center text-slate-700 mb-6">Student Records</h2>
                <div class="w-full">
                    <label for="class-filter-select" class="block text-sm font-medium text-gray-700">Filter by Class</label>
                    <select id="class-filter-select" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        <option value="all">All Classes Records</option>
                        <option value="Class-1">Class-1</option>
                        <option value="Class-2">Class-2</option>
                        <option value="Class-3">Class-3</option>
                    </select>
                </div>
                
                <!-- Updated statistics section -->
                <div class="flex w-full justify-between items-center bg-white p-4 rounded-lg shadow-md border border-slate-200 mt-6">
                    <div class="text-center flex-1">
                        <p class="text-sm font-semibold text-gray-500">Total Students</p>
                        <p id="total-students-records" class="text-2xl font-bold text-slate-800 mt-1">0</p>
                    </div>
                    <div class="text-center flex-1">
                        <p class="text-sm font-semibold text-gray-500">Total Male</p>
                        <p id="total-male-records" class="text-2xl font-bold text-blue-500 mt-1">0</p>
                    </div>
                    <div class="text-center flex-1">
                        <p class="text-sm font-semibold text-gray-500">Total Female</p>
                        <p id="total-female-records" class="text-2xl font-bold text-pink-500 mt-1">0</p>
                    </div>
                </div>
            </div>
            <div id="records-container" class="bg-gray-100 p-4 rounded-lg border-2 border-gray-300 max-h-96 overflow-y-auto">
                <p class="text-gray-500 text-center">Select a class and click 'Load Records' to view.</p>
            </div>
            <div class="flex justify-between space-x-4 pt-4">
                <button type="button" id="back-btn-view-records"
                        class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-500 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                        Back
                    </button>
            </div>
        </div>

        <!-- Update Payment Section -->
        <div id="update-payment-section" class="hidden">
            <h2 class="text-3xl font-bold text-center text-slate-700 mb-6">Update Payment</h2>
            <div class="space-y-6">
                <div>
                    <label for="payment-admission-no" class="block text-sm font-medium text-gray-700">Admission No</label>
                    <input type="text" id="payment-admission-no" name="Admission No" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                </div>
                <div class="flex justify-between space-x-4 pt-4">
                    <button type="button" id="search-payment-btn"
                            class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                        Search
                    </button>
                </div>

                <!-- Student Details Display Area -->
                <div id="student-details-container" class="bg-gray-100 p-6 rounded-lg border-2 border-gray-300 hidden">
                    <h3 class="text-xl font-bold text-slate-700 mb-4">Student Details</h3>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <span class="font-semibold text-gray-600">Admission No:</span>
                            <span id="student-admissionno-display" class="text-gray-900"></span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="font-semibold text-gray-600">Name:</span>
                            <span id="student-name-display" class="text-gray-900"></span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="font-semibold text-gray-600">Class:</span>
                            <span id="student-class-display" class="text-gray-900"></span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="font-semibold text-gray-600">Roll No:</span>
                            <span id="student-rollno-display" class="text-gray-900"></span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="font-semibold text-gray-600">Section:</span>
                            <span id="student-section-display" class="text-gray-900"></span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="font-semibold text-gray-600">Father Name:</span>
                            <span id="student-father-display" class="text-gray-900"></span>
                        </div>
                    </div>

                    <!-- Payment Update Form -->
                    <h3 class="text-xl font-bold text-slate-700 mt-8 mb-4">Update Payment</h3>
                    <p class="text-sm text-gray-500 mb-4 italic">The payment date will be recorded automatically with the current system time.</p>
                    <form id="payment-form" class="space-y-4">
                        <!-- New 'Type of Payment' dropdown -->
                        <div>
                            <label for="payment-type" class="block text-sm font-medium text-gray-700">Type of Payment</label>
                            <select id="payment-type" name="Payment Type" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                                <option value="">Select Payment Type</option>
                                <option value="Admission">Admission</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        <div>
                            <label for="payment-amount" class="block text-sm font-medium text-gray-700">Payment Amount</label>
                            <input type="number" id="payment-amount" name="Payment Amount" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                        </div>
                        <button type="submit"
                                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                            Submit Payment
                        </button>
                    </form>

                    <!-- Payment History Section -->
                    <div id="payment-history-container" class="mt-8 hidden">
                        <h3 class="text-xl font-bold text-slate-700 mb-4">Payment History</h3>
                        <div id="payment-history-table-container" class="bg-white p-4 rounded-lg border border-gray-300 max-h-64 overflow-y-auto">
                            <!-- Payment history table will be inserted here -->
                        </div>
                    </div>
                </div>

                <div class="flex justify-between space-x-4 pt-4">
                    <button type="button" id="back-btn-payment"
                            class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-500 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                        Back
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Payment Status Section (Informational Only) -->
        <div id="payment-status-section" class="hidden">
            <h2 class="text-3xl font-bold text-center text-slate-700 mb-6">Payment Status Viewer</h2>
            <p class="text-center text-gray-500">The "Payment Status" button is configured to open a link in a new tab for external checking.</p>
            <div class="flex justify-between space-x-4 pt-4">
                <button type="button" id="back-btn-payment-status"
                        class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-500 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                    Back
                </button>
            </div>
        </div>
        
        <!-- Status Messages -->
        <div id="message-box" class="mt-8 text-center font-semibold hidden"></div>
        <div id="loading-indicator" class="mt-8 text-center hidden">
            <div class="flex justify-center items-center">
                <div class="w-8 h-8 border-4 border-t-4 border-gray-200 border-t-indigo-500 rounded-full animate-spin"></div>
            </div>
        </div>
    </div>

    <!-- 1. The Passcode Modal (UPDATED FOR NO HINTS) -->
    <div id="passcodeModal" class="modal">
      <div class="modal-content w-full max-w-sm">
        <span id="passcode-close-btn" class="close-btn">&times;</span>
        <h3 id="modal-action-title" class="text-2xl font-bold text-slate-700 mb-4 text-center">Access Required</h3>
        <p id="modal-passcode-hint" class="text-sm text-gray-500 mb-6 text-center">Please enter the passcode to continue.</p>
        <form id="passcode-form" class="space-y-4">
            <input type="password" id="passcode-input" placeholder="Enter Passcode" class="mt-1 block w-full rounded-md border-2 border-gray-800 bg-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 text-center" required maxlength="4">
            <div id="passcode-error-message" class="text-red-500 text-sm font-medium text-center hidden"></div>
            <button type="submit"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                Unlock
            </button>
        </form>
      </div>
    </div>

    <!-- 2. The Receipt Modal (Existing) -->
    <div id="receiptModal" class="modal">
      <div class="modal-content w-full max-w-4xl">
        <span id="receipt-close-btn" class="close-btn">&times;</span>
        <div id="receipt-details" class="receipt">
            <div class="text-center">
                <h1 class="font-bold text-4xl">Manipur</h1>
                <h2 class="font-bold text-3xl">The Demo School</h2>
                <h3 class="font-bold text-2xl underline">Payment Receipt</h3>
            </div>
            
            <div class="flex-grow space-y-4 my-8">
                <!-- Receipt Number -->
                <div class="flex justify-end">
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold text-gray-600">Receipt No:</span>
                        <span id="receipt-number" class="text-gray-900 font-bold"></span>
                    </div>
                </div>

                <!-- Fields Grid -->
                <div class="grid grid-cols-2 gap-x-12 gap-y-4 text-lg">
                    <div class="receipt-field">
                        <span class="font-semibold text-gray-600">Admission No:</span>
                        <span id="receipt-admission-no" class="text-gray-900"></span>
                    </div>
                    <div class="receipt-field">
                        <span class="font-semibold text-gray-600">Name:</span>
                        <span id="receipt-name" class="text-gray-900"></span>
                    </div>
                    <div class="receipt-field">
                        <span class="font-semibold text-gray-600">Class:</span>
                        <span id="receipt-class" class="text-gray-900"></span>
                    </div>
                    <div class="receipt-field">
                        <span class="font-semibold text-gray-600">Roll No:</span>
                        <span id="receipt-roll-no" class="text-gray-900"></span>
                    </div>
                    <div class="receipt-field">
                        <span class="font-semibold text-gray-600">Section:</span>
                        <span id="receipt-section" class="text-gray-900"></span>
                    </div>
                    <div class="receipt-field">
                        <span class="font-semibold text-gray-600">Father Name:</span>
                        <span id="receipt-father-name" class="text-gray-900"></span>
                    </div>
                    <div class="receipt-field">
                        <span class="font-semibold text-gray-600">Payment Type:</span>
                        <span id="receipt-payment-type" class="text-gray-900"></span>
                    </div>
                    <div class="receipt-field">
                        <span class="font-semibold text-gray-600">Amount:</span>
                        <span id="receipt-payment-amount" class="text-gray-900"></span>
                    </div>
                    <div class="receipt-field">
                        <span class="font-semibold text-gray-600">Payment Date:</span>
                        <span id="receipt-payment-date" class="text-gray-900"></span>
                    </div>
                </div>
            </div>

            <!-- Signature -->
            <div class="flex justify-end mt-4">
                <div class="flex flex-col items-center">
                    <div class="w-40 h-px bg-gray-400 mb-1"></div>
                    <span class="text-lg text-gray-500">Signature</span>
                </div>
            </div>
            
        </div>
        <div class="mt-4 flex justify-center">
            <button id="print-receipt-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out transform hover:scale-105 hover:shadow-xl">
                Print Receipt
            </button>
        </div>
      </div>
    </div>

    <script>
        // --- IMPORTANT: CONFIGURATION ---
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYbNtc2fMIp2ev9Ypge-b2OymLUf7q9-5WbkBL9eN6nJX-ocZH-Xwum8rxS6FCT9R5/exec";
        
        // --- UNIQUE PASSCODES ---
        const PASSCODES = {
            'UPDATE_STUDENT': '2001',
            'VIEW_RECORDS': '2002',
            'UPDATE_PAYMENT': '2003',
            'PAYMENT_STATUS': '2004'
        };

        // DOM Elements
        const mainMenu = document.getElementById('main-menu');
        const studentFormSection = document.getElementById('student-form-section');
        const bulkUpdateSection = document.getElementById('bulk-update-section');
        const bulkPreviewSection = document.getElementById('bulk-preview-section');
        const viewRecordsSection = document.getElementById('view-records-section');
        const updatePaymentSection = document.getElementById('update-payment-section');
        const paymentStatusSection = document.getElementById('payment-status-section'); 
        const studentEntryForm = document.getElementById('student-entry-form');
        const messageBox = document.getElementById('message-box');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        // Button Elements
        const updateStudentBtn = document.getElementById('update-student-btn');
        const viewRecordsBtn = document.getElementById('view-records-btn');
        const updatePaymentBtn = document.getElementById('update-payment-btn');
        const paymentStatusBtn = document.getElementById('payment-status-btn'); 
        const backBtnForm = document.getElementById('back-btn-form');
        const bulkUpdateBtnForm = document.getElementById('bulk-update-btn-form');
        const backBtnBulk = document.getElementById('back-btn-bulk');
        const backBtnPreview = document.getElementById('back-btn-preview');
        const backBtnViewRecords = document.getElementById('back-btn-view-records');
        const backBtnPayment = document.getElementById('back-btn-payment');
        const backBtnPaymentStatus = document.getElementById('back-btn-payment-status'); 
        const searchPaymentBtn = document.getElementById('search-payment-btn');
        const paymentForm = document.getElementById('payment-form');

        // Bulk Update Elements (omitted for brevity)
        const bulkClassNameSelect = document.getElementById('bulk-class-name');
        const bulkUploadFile = document.getElementById('bulk-upload-file');
        const previewTableContainer = document.getElementById('preview-table-container');
        const downloadTemplateBtn = document.getElementById('download-template-btn');
        const viewAndConformBtn = document.getElementById('view-and-conform-btn');
        const confirmUploadBtn = document.getElementById('confirm-upload-btn');
        const totalStudentsCount = document.getElementById('total-students-count');
        const totalMaleCount = document.getElementById('total-male-count');
        const totalFemaleCount = document.getElementById('total-female-count');

        // Payment Elements (omitted for brevity)
        const paymentAdmissionNo = document.getElementById('payment-admission-no');
        const studentDetailsContainer = document.getElementById('student-details-container');
        const studentAdmissionNoDisplay = document.getElementById('student-admissionno-display');
        const studentNameDisplay = document.getElementById('student-name-display');
        const studentClassDisplay = document.getElementById('student-class-display');
        const studentRollNoDisplay = document.getElementById('student-rollno-display');
        const studentSectionDisplay = document.getElementById('student-section-display');
        const studentFatherDisplay = document = document.getElementById('student-father-display');
        const paymentHistoryContainer = document.getElementById('payment-history-container');
        const paymentHistoryTableContainer = document.getElementById('payment-history-table-container');

        // View Records Elements (omitted for brevity)
        const recordsContainer = document.getElementById('records-container');
        const classFilterSelect = document.getElementById('class-filter-select');
        const totalStudentsRecords = document.getElementById('total-students-records');
        const totalMaleRecords = document.getElementById('total-male-records');
        const totalFemaleRecords = document.getElementById('total-female-records');
        const recordsTitle = document.getElementById('records-title');

        // Modal Elements
        const receiptModal = document.getElementById("receiptModal");
        const receiptCloseBtn = document.getElementById("receipt-close-btn");
        const printReceiptBtn = document.getElementById("print-receipt-btn");
        
        // NEW Passcode Modal Elements (Updated IDs)
        const passcodeModal = document.getElementById("passcodeModal");
        const passcodeCloseBtn = document.getElementById("passcode-close-btn");
        const passcodeForm = document.getElementById("passcode-form");
        const passcodeInput = document.getElementById("passcode-input");
        const passcodeErrorMessage = document.getElementById("passcode-error-message");
        const modalActionTitle = document.getElementById('modal-action-title');
        const modalPasscodeHint = document.getElementById('modal-passcode-hint');

        // Global variables for caching data and student details
        let allStudentsData = [];
        let allHeaders = [];
        let foundStudentData = null; // Store the found student object
        
        // Global variables for dynamic passcode handling
        let pendingAction = null; 
        let pendingRequiredCode = null; // Store the required code
        let pendingActionLabel = ""; // Store the action label for display
        
        // --- CENTRALIZED SECTION MANAGEMENT (FIX) ---
        const menuSections = [
            mainMenu,
            studentFormSection,
            bulkUpdateSection,
            bulkPreviewSection,
            viewRecordsSection,
            updatePaymentSection,
            paymentStatusSection
        ];

        /**
         * Hides all main content sections and shows only the specified one.
         * This is the core navigation fix for reliability.
         * @param {HTMLElement} sectionToShow The section element to make visible.
         */
        function showSection(sectionToShow) {
            console.log('Switching section to:', sectionToShow.id);
            menuSections.forEach(section => {
                section.classList.add('hidden');
            });
            sectionToShow.classList.remove('hidden');
        }
        
        // Utility Functions (unchanged)
        function showMessage(message, color) {
            messageBox.textContent = message;
            messageBox.className = `mt-8 text-center font-semibold block text-${color}-600`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }
        
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        function checkUrl() {
            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_HERE') {
                showMessage('Error: Please update the APPS_SCRIPT_URL with your own deployed script URL.', 'red');
                hideLoading();
                return false;
            }
            return true;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function formatDateTime(date) {
            if (!date || isNaN(date.getTime())) return 'Invalid Date';
            return date.toLocaleString();
        }
        
        // --- PASSCODE LOGIC (UPDATED: HINT REMOVED) ---
        
        /**
         * Displays the passcode modal, sets the intended action, and stores the required code.
         * @param {Function} action A function to execute on successful passcode entry.
         * @param {string} requiredCode The unique passcode required for this action.
         * @param {string} actionLabel A user-friendly name for the action.
         */
        function showPasscodeModal(action, requiredCode, actionLabel) {
            pendingAction = action;
            pendingRequiredCode = requiredCode; // Store the required code
            pendingActionLabel = actionLabel; // Store the action label for display
            
            passcodeInput.value = ''; // Clear previous input
            passcodeErrorMessage.classList.add('hidden'); // Clear previous error
            
            // Update modal title and hint (HINT REMOVED)
            modalActionTitle.textContent = `Access Required: ${actionLabel}`;
            modalPasscodeHint.textContent = `Please enter the passcode for ${actionLabel}.`; 
            
            passcodeModal.style.display = 'flex';
            
            // Ensure focus is correctly applied for immediate typing
            setTimeout(() => passcodeInput.focus(), 100); 
        }

        /**
         * Closes the passcode modal and resets the pending state.
         */
        function closePasscodeModal() {
            passcodeModal.style.display = 'none';
            pendingAction = null;
            pendingRequiredCode = null;
            pendingActionLabel = "";
        }

        /**
         * Handles the dynamic passcode submission and validation.
         */
        passcodeForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const enteredPasscode = passcodeInput.value.trim();

            if (enteredPasscode === pendingRequiredCode) {
                passcodeErrorMessage.classList.add('hidden');
                
                // Add a small delay for cleaner transition after modal closure
                setTimeout(() => {
                    if (pendingAction) {
                        pendingAction(); // Execute the stored action (e.g., showSection)
                        console.log(`Passcode accepted for ${pendingActionLabel}. Executing action.`);
                    }
                    closePasscodeModal(); // Close modal after action is initiated
                }, 100); 
                
            } else {
                // Error message without the hint
                passcodeErrorMessage.textContent = `Invalid Passcode for ${pendingActionLabel}. Try again.`;
                passcodeErrorMessage.classList.remove('hidden');
                passcodeInput.value = '';
                passcodeInput.focus();
                console.warn('Passcode rejected.');
            }
        });
        
        passcodeCloseBtn.onclick = closePasscodeModal;

        // --- UPDATED EVENT LISTENERS - Navigation (Using Dynamic Passcodes) ---
        
        updateStudentBtn.addEventListener('click', () => {
            showPasscodeModal(() => {
                showSection(studentFormSection);
            }, PASSCODES.UPDATE_STUDENT, "Update Student");
        });

        viewRecordsBtn.addEventListener('click', () => {
            showPasscodeModal(() => {
                showSection(viewRecordsSection);
                fetchAllRecords();
            }, PASSCODES.VIEW_RECORDS, "View Records");
        });

        updatePaymentBtn.addEventListener('click', () => {
            showPasscodeModal(() => {
                showSection(updatePaymentSection);
            }, PASSCODES.UPDATE_PAYMENT, "Update Payment");
        });
        
        // Passcode check for the "Payment Status" button
        paymentStatusBtn.addEventListener('click', () => {
            showPasscodeModal(() => {
                // This function currently just opens a new tab/link
                window.open('https://lsurjit.github.io/thedemoschool/'); 
            }, PASSCODES.PAYMENT_STATUS, "Payment Status");
        });

        // Event Listeners - Back buttons (no passcode required)
        backBtnForm.addEventListener('click', () => { showSection(mainMenu); console.log('Navigated back to main menu from form.'); });
        backBtnBulk.addEventListener('click', () => { showSection(mainMenu); console.log('Navigated back to main menu from bulk update.'); });
        backBtnPreview.addEventListener('click', () => { showSection(bulkUpdateSection); console.log('Navigated back to bulk update from preview.'); });
        backBtnViewRecords.addEventListener('click', () => { showSection(mainMenu); console.log('Navigated back to main menu from view records.'); });
        backBtnPayment.addEventListener('click', () => { showSection(mainMenu); console.log('Navigated back to main menu from update payment.'); });
        backBtnPaymentStatus.addEventListener('click', () => { showSection(mainMenu); console.log('Navigated back to main menu from payment status (Informational section).'); });

        // Event Listeners - Form Submission (unchanged)
        studentEntryForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!checkUrl()) return;

            showLoading();

            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            const admissionNo = data['Admission No'];

            try {
                // Check if student already exists
                const searchResponse = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'searchStudent', admissionNo: admissionNo }).toString()
                });

                const searchResult = await searchResponse.json();
                
                if (searchResult.success) {
                    showMessage('A student with this Admission No. already exists. Please use a different one.', 'red');
                    hideLoading();
                    return;
                }

                // Submit new student data
                data.action = 'updateStudent';
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(data).toString()
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'indigo');
                    event.target.reset();
                } else {
                    showMessage(result.message, 'red');
                }
            } catch (error) {
                console.error('Failed to connect to the server. Please check your Google Apps Script deployment.', error);
                showMessage(`Failed to connect to the server. Please ensure your script is deployed to "Anyone".`, 'red');
            } finally {
                hideLoading();
            }
        });

        // Event Listeners - Bulk Update (unchanged)
        bulkUpdateBtnForm.addEventListener('click', function() { showSection(bulkUpdateSection); });

        viewAndConformBtn.addEventListener('click', function() {
            const file = bulkUploadFile.files[0];
            const className = bulkClassNameSelect.value;
            
            if (!className) {
                showMessage('Please select a class name first.', 'red');
                return;
            }

            if (!file) {
                showMessage('Please select a file to upload.', 'red');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length <= 1) {
                    showMessage('File is empty or not in the correct format.', 'red');
                    return;
                }

                const headers = lines[0].split(',').map(header => header.trim());
                const dataLines = lines.slice(1);
                
                const studentsData = dataLines.map(line => {
                    const values = line.split(',').map(item => item.trim());
                    const student = {};
                    headers.forEach((header, index) => {
                        student[header] = values[index];
                    });
                    return student;
                });


                // Calculate gender statistics
                const totalStudents = studentsData.length;
                let maleCount = 0;
                let femaleCount = 0;
                
                const genderHeader = headers.find(header => header.toLowerCase() === 'gender');
                
                if (genderHeader) {
                    studentsData.forEach(student => {
                        const gender = student[genderHeader]?.toLowerCase();
                        if (gender === 'male') maleCount++;
                        else if (gender === 'female') femaleCount++;
                    });
                }

                // Update summary counts
                totalStudentsCount.textContent = totalStudents;
                totalMaleCount.textContent = maleCount;
                totalFemaleCount.textContent = femaleCount;

                // Build and display the table
                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">Sl. No.</th>
                                ${headers.map(header => 
                                    `<th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">${header}</th>`
                                ).join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                `;
                
                const dobHeader = headers.find(header => header.toLowerCase() === 'date of birth');
                
                studentsData.forEach((student, index) => {
                    tableHTML += `
                        <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">${index + 1}</td>
                            ${Object.keys(student).map(key => 
                                `<td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">${key.toLowerCase() === 'date of birth' ? formatDate(student[key]) : student[key]}</td>`
                            ).join('')}
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                previewTableContainer.innerHTML = tableHTML;
                showSection(bulkPreviewSection);
            };
            reader.readAsText(file);
        });

        downloadTemplateBtn.addEventListener('click', function() {
            const template = "Class Name,Admission No,Name,Roll No,Section,Gender,Date of Birth,Father Name,Address,Contact No\nClass-1,123,John Doe,1,A,Male,2005-01-15,Richard Doe,123 Main St,123-456-7890";
            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'student_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('Downloading template file.');
            showMessage('Template downloaded successfully!', 'green');
        });

        confirmUploadBtn.addEventListener('click', async function() {
            if (!checkUrl()) return;
            
            const file = bulkUploadFile.files[0];
            const className = bulkClassNameSelect.value;
            
            showLoading();
            messageBox.classList.add('hidden'); // Clear previous messages

            const reader = new FileReader();
            reader.onload = async function(e) {
                const csvContent = e.target.result;
                const lines = csvContent.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length <= 1) {
                    showMessage('File is empty or not in the correct format.', 'red');
                    hideLoading();
                    return;
                }

                const headers = lines[0].split(',').map(header => header.trim());
                const dataLines = lines.slice(1);
                
                const studentsData = dataLines.map(line => {
                    const values = line.split(',').map(item => item.trim());
                    const student = {};
                    headers.forEach((header, index) => {
                        student[header] = values[index];
                    });
                    return student;
                });
                
                const encodedData = btoa(unescape(encodeURIComponent(JSON.stringify(studentsData))));
                
                const formData = {
                    action: 'bulkUpload',
                    className: className,
                    data: encodedData
                };

                try { 
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams(formData).toString()
                    });

                    const result = await response.json();
                    if (result.success) {
                        showMessage(result.message, 'indigo');
                        showSection(bulkUpdateSection);
                    } else {
                        if (result.duplicates && result.duplicates.length > 0) {
                             const duplicateList = result.duplicates.join(', ');
                             showMessage(`Error: The following Admission No(s) already exist: ${duplicateList}`, 'red');
                        } else {
                             showMessage(result.message, 'red');
                        }
                    }
                } catch (error) { 
                    console.error('Failed to connect to the server. Please check your Google Apps Script deployment.', error);
                    showMessage(`Failed to connect to the server. Please ensure your script is deployed to "Anyone".`, 'red');
                } finally {
                    hideLoading();
                }
            };
            reader.readAsText(file);
        });
        
        // Event Listeners - Payment (unchanged)
        searchPaymentBtn.addEventListener('click', async function() {
            if (!checkUrl()) return;

            const admissionNo = paymentAdmissionNo.value;

            if (!admissionNo) {
                showMessage('Please enter an Admission No.', 'red');
                return;
            }

            showLoading();
            studentDetailsContainer.classList.add('hidden'); // Hide container before search
            paymentHistoryContainer.classList.add('hidden'); // Hide history container as well

            const formData = {
                action: 'searchStudent',
                admissionNo: admissionNo
            };

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(formData).toString()
                });

                if (!response.ok) {
                    showMessage('Server error. Please check your Google Apps Script deployment.', 'red');
                    hideLoading();
                    return;
                }

                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'green');
                    foundStudentData = result.data;
                    studentAdmissionNoDisplay.textContent = foundStudentData['Admission No'];
                    studentNameDisplay.textContent = foundStudentData['Name'];
                    studentClassDisplay.textContent = foundStudentData['Class Name'];
                    studentRollNoDisplay.textContent = foundStudentData['Roll No'];
                    studentSectionDisplay.textContent = foundStudentData['Section'];
                    studentFatherDisplay.textContent = foundStudentData['Father Name'];
                    studentDetailsContainer.classList.remove('hidden');

                    // Fetch and display payment history after finding student
                    await fetchPaymentHistory(foundStudentData['Admission No']);
                    
                } else {
                    showMessage(result.message, 'red');
                    studentDetailsContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error('A critical error occurred during the search:', error);
                showMessage(`Failed to connect to the server. Please ensure your script is deployed to "Anyone".`, 'red');
                studentDetailsContainer.classList.add('hidden'); // Hide container on error
            } finally {
                hideLoading();
            }
        });

        paymentForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!foundStudentData) {
                showMessage('Please search for a student first.', 'red');
                return;
            }

            if (!checkUrl()) return;

            showLoading();
            const formData = new FormData(event.target);
            const paymentData = Object.fromEntries(formData.entries());

            const data = {
                action: 'updatePayment',
                admissionNo: foundStudentData['Admission No'],
                paymentType: paymentData['Payment Type'],
                paymentAmount: paymentData['Payment Amount']
            };

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(data).toString()
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'indigo');
                    paymentForm.reset();
                    // Fetch and display updated payment history
                    await fetchPaymentHistory(foundStudentData['Admission No']);
                } else {
                    showMessage(result.message, 'red');
                }
            } catch (error) {
                console.error('Failed to submit payment data.', error);
                showMessage(`Failed to submit payment data.`, 'red');
            } finally {
                hideLoading();
            }
        });

        /**
         * Fetches and renders the payment history for a given admission number.
         * @param {string} admissionNo The admission number to search for.
         */
        async function fetchPaymentHistory(admissionNo) {
            if (!checkUrl()) return;
            
            paymentHistoryTableContainer.innerHTML = '<p class="text-gray-500 text-center">Loading history...</p>';
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'getPaymentHistory', admissionNo: admissionNo }).toString()
                });

                const result = await response.json();

                if (result.success) {
                    renderPaymentHistory(result.history);
                } else {
                    paymentHistoryTableContainer.innerHTML = '<p class="text-gray-500 text-center">Failed to load payment history.</p>';
                }
            } catch (error) {
                console.error('Error fetching payment history:', error);
                paymentHistoryTableContainer.innerHTML = '<p class="text-gray-500 text-center">Error loading history.</p>';
            }
        }

        /**
         * Renders the payment history table.
         * @param {Array<Object>} payments An array of payment objects.
         */
        function renderPaymentHistory(payments) {
            if (payments.length === 0) {
                paymentHistoryTableContainer.innerHTML = '<p class="text-gray-500 text-center">No payment records found.</p>';
                paymentHistoryContainer.classList.remove('hidden');
                return;
            }
            
            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="py-2 px-3 text-left text-xs font-semibold text-gray-900">Type</th>
                            <th scope="col" class="py-2 px-3 text-left text-xs font-semibold text-gray-900">Date</th>
                            <th scope="col" class="py-2 px-3 text-left text-xs font-semibold text-gray-900">Amount</th>
                            <th scope="col" class="py-2 px-3 text-left text-xs font-semibold text-gray-900">View</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
            `;
            
            payments.forEach((payment, index) => {
                tableHTML += `
                    <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                        <td class="whitespace-nowrap py-2 px-3 text-sm text-gray-900">${payment['Payment Type']}</td>
                        <td class="whitespace-nowrap py-2 px-3 text-sm text-gray-900">${formatDateTime(new Date(payment['Payment Date']))}</td>
                        <td class="whitespace-nowrap py-2 px-3 text-sm text-gray-900">Rs. ${payment['Payment Amount']}</td>
                        <td class="whitespace-nowrap py-2 px-3 text-sm text-gray-900">
                            <button onclick="openReceiptModal('${payment['Payment Type']}', '${payment['Payment Amount']}', '${formatDateTime(new Date(payment['Payment Date']))}')" class="text-indigo-600 hover:text-indigo-900">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3.75 6.75a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H4.5a.75.75 0 01-.75-.75zM3.75 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H4.5a.75.75 0 01-.75-.75zM3.75 13.25a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H4.5a.75.75 0 01-.75-.75zM3.75 16.5a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H4.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            paymentHistoryTableContainer.innerHTML = tableHTML;
            paymentHistoryContainer.classList.remove('hidden');
        }

        // Function to fetch and display student records (unchanged)
        async function fetchAllRecords() {
            if (!checkUrl()) return;

            recordsContainer.innerHTML = '<p class="text-gray-500 text-center">Loading records...</p>';
            totalStudentsRecords.textContent = '0';
            totalMaleRecords.textContent = '0';
            totalFemaleRecords.textContent = '0';
            showLoading();
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'getAllRecords' }).toString()
                });

                const result = await response.json();
                
                if (result.success && result.data.data.length > 0) {
                    allHeaders = result.data.headers;
                    allStudentsData = result.data.data;
                    renderFilteredRecords();
                } else {
                    recordsContainer.innerHTML = '<p class="text-gray-500 text-center">No student records found for this class.</p>';
                    showMessage('No records found.', 'red');
                    totalStudentsRecords.textContent = '0';
                    totalMaleRecords.textContent = '0';
                    totalFemaleRecords.textContent = '0';
                }
            } catch (error) {
                console.error('Failed to fetch records. Please check your Google Apps Script deployment.', error);
                recordsContainer.innerHTML = '<p class="text-gray-500 text-center">Failed to fetch records.</p>';
                showMessage(`Failed to connect to the server. Please ensure your script is deployed to "Anyone".`, 'red');
                totalStudentsRecords.textContent = '0';
                totalMaleRecords.textContent = '0';
                totalFemaleRecords.textContent = '0';
            } finally {
                hideLoading();
            }
        }

        // Function to render records based on current filters (unchanged)
        function renderFilteredRecords() {
            recordsContainer.innerHTML = '<p class="text-gray-500 text-center">Filtering records...</p>';
            const selectedClass = classFilterSelect.value;
            
            // Update the title based on the selected class
            if (selectedClass === 'all') {
                recordsTitle.textContent = 'All Classes Records';
            } else {
                recordsTitle.textContent = selectedClass + ' Records';
            }
            
            let filteredStudents = allStudentsData;
            
            // Filter by class
            if (selectedClass !== 'all') {
                const classNameIndex = allHeaders.findIndex(header => header.toLowerCase() === 'class name');
                if (classNameIndex !== -1) {
                    filteredStudents = filteredStudents.filter(student => student[classNameIndex] === selectedClass);
                }
            }
            
            if (filteredStudents.length > 0) {
                const genderIndex = allHeaders.findIndex(header => header.toLowerCase() === 'gender');
                const dobIndex = allHeaders.findIndex(header => header.toLowerCase() === 'date of birth');
                
                // Calculate statistics
                let maleCount = 0;
                let femaleCount = 0;
                if (genderIndex !== -1) {
                    filteredStudents.forEach(student => {
                        const gender = student[genderIndex]?.toLowerCase();
                        if (gender === 'male') {
                            maleCount++;
                        } else if (gender === 'female') {
                            femaleCount++;
                        }
                    });
                }
                
                // Update statistics display
                totalStudentsRecords.textContent = filteredStudents.length;
                totalMaleRecords.textContent = maleCount;
                totalFemaleRecords.textContent = femaleCount;

                // Build and display the table
                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">Sl. No.</th>
                                ${allHeaders.map(header => 
                                    `<th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">${header}</th>`
                                ).join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                `;

                filteredStudents.forEach((student, index) => {
                    tableHTML += `
                        <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">${index + 1}</td>
                            ${student.map((item, itemIndex) => {
                                if (itemIndex === dobIndex) {
                                    return `<td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">${formatDate(item)}</td>`;
                                } else {
                                    return `<td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">${item}</td>`;
                                }
                            }).join('')}
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                recordsContainer.innerHTML = tableHTML;
            } else {
                recordsContainer.innerHTML = '<p class="text-gray-500 text-center">No matching student records found.</p>';
                totalStudentsRecords.textContent = '0';
                totalMaleRecords.textContent = '0';
                totalFemaleRecords.textContent = '0';
            }
        }
        
        // Modal functions (unchanged)
        function openReceiptModal(paymentType, paymentAmount, paymentDate) {
            // Populate student details from the globally available foundStudentData
            document.getElementById('receipt-name').textContent = foundStudentData['Name'];
            document.getElementById('receipt-admission-no').textContent = foundStudentData['Admission No'];
            document.getElementById('receipt-class').textContent = foundStudentData['Class Name'];
            document.getElementById('receipt-roll-no').textContent = foundStudentData['Roll No'];
            document.getElementById('receipt-section').textContent = foundStudentData['Section'];
            document.getElementById('receipt-father-name').textContent = foundStudentData['Father Name'];

            // Populate payment details
            document.getElementById('receipt-payment-type').textContent = paymentType;
            document.getElementById('receipt-payment-amount').textContent = `Rs. ${paymentAmount}`;
            document.getElementById('receipt-payment-date').textContent = paymentDate;
            
            // Generate and set the receipt number
            document.getElementById('receipt-number').textContent = Math.floor(10000000 + Math.random() * 90000000);
            
            receiptModal.style.display = 'flex';
        }

        // Close receipt modal
        receiptCloseBtn.onclick = function() {
            receiptModal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == receiptModal) {
                receiptModal.style.display = "none";
            } else if (event.target == passcodeModal) {
                closePasscodeModal();
            }
        }
        
        // Print receipt
        printReceiptBtn.onclick = function() {
            window.print();
        }

        // Handle ESC key to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (passcodeModal.style.display === 'flex') {
                    closePasscodeModal();
                } else if (receiptModal.style.display === 'flex') {
                    receiptModal.style.display = 'none';
                }
            }
        });
        
        window.onload = function() {
            showSection(mainMenu);
        };
    </script>
</body>
</html>
